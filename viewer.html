<!DOCTYPE html>
<html>
<head>
  <title>Video Stream Viewer</title>
</head>
<body>
  <div style="position: relative; width: 640px; height: 320px; border: 2px solid rgb(52, 52, 129); border-radius: 5px">
    <div style="display: inline-block; padding: 5px 10px; 
    background: rgb(192, 59, 59); color: white; 
    font-weight: bold; position: absolute; left: 0; top: 0;z-index: 1">LIVE FEED</div>
    <video id="videoElement" controls 
    width="640" height="320" 
    style=""></video>
  </div>
  <br>
  <textarea id="status" style="width:640px; height: 320px"></textarea>
  <script>
    const video = document.getElementById('videoElement');
    const status = document.getElementById('status');
    const mediaSource = new MediaSource();
    let sourceBuffer;
    let isInitialized = false;
    let pendingChunks = [];

    video.src = URL.createObjectURL(mediaSource);

    function appendChunk(chunk) {
      if (!sourceBuffer.updating && pendingChunks.length > 0) {
        const nextChunk = pendingChunks.shift();
        sourceBuffer.appendBuffer(nextChunk);
      }
    }

    mediaSource.addEventListener('sourceopen', () => {
      status.textContent = 'MediaSource opened';
      sourceBuffer = mediaSource.addSourceBuffer('video/webm;codecs=vp8');
      const ws = new WebSocket('ws://localhost:8080');

      ws.onopen = () => {
        status.textContent += '\nWebSocket connected';
      };

      ws.onmessage = async (event) => {
        const blob = new Blob([event.data]);
        const data = await blob.arrayBuffer();

        if (!isInitialized) {
          sourceBuffer.appendBuffer(data);
          isInitialized = true;
          status.textContent += '\nInitialization segment received and appended';
        } else {
          if (!sourceBuffer.updating) {
            sourceBuffer.appendBuffer(data);
          } else {
            pendingChunks.push(data);
          }
          status.textContent += '\nReceived and queued chunk of size: ' + event.data.size;
        }

        if (video.paused) {
          video.play().catch(e => console.error('Error playing video:', e));
        }
      };

      ws.onerror = (error) => {
        status.textContent += '\nWebSocket error: ' + error.message;
      };

      sourceBuffer.addEventListener('updateend', () => {
        status.textContent += '\nSource buffer updated';
        appendChunk();
      });
    });

    video.addEventListener('error', (e) => {
      status.textContent += '\nVideo error: ' + video.error.message;
    });
  </script>
</body>
</html>