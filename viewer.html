<!DOCTYPE html>
<html>
<head>
  <title>Video Stream Viewer</title>
</head>
<body>
  <div style="position: relative; width: 640px; height: 320px; border: 2px solid rgb(52, 52, 129); border-radius: 5px">
    <div style="display: inline-block; padding: 5px 10px; 
    background: rgb(192, 59, 59); color: white; 
    font-weight: bold; position: absolute; left: 0; top: 0;z-index: 1">LIVE FEED</div>

    <video id="videoElement" controls muted autoplay
    width="640" height="320" 
    style=""></video>
  </div>
  <br>
  <textarea id="status" style="width:640px; height: 320px"></textarea>
  <script>
    const video = document.getElementById('videoElement');
    const status = document.getElementById('status');
    const mediaSource = new MediaSource();
    let sourceBuffer;
    let isInitialized = false;

    video.src = URL.createObjectURL(mediaSource);

    function log(message) {
      // console.log(message);
      status.value += message + '\n';
      // status.scrollTop = status.scrollHeight;
    }

    mediaSource.addEventListener('sourceopen', () => {
      log('MediaSource opened');
      sourceBuffer = mediaSource.addSourceBuffer('video/webm;codecs=vp8');
      sourceBuffer.mode = 'sequence';
      const ws = new WebSocket('ws://localhost:8080');

      ws.onopen = () => {
        log('WebSocket connected');
      };

      ws.onmessage = async (event) => {
        const data = await event.data.arrayBuffer();
        log(`Received chunk of size: ${data.byteLength}`);

        if (!sourceBuffer.updating) {
          try {
            sourceBuffer.appendBuffer(data);
            log('Segment appended');
          } catch (e) {
            log(`Error appending buffer: ${e.message}`);
          }
        } else {
          log('Source buffer is updating, waiting...');
        }

        // if (video.paused && sourceBuffer.buffered.length > 0) {
        //   video.currentTime = sourceBuffer.buffered.start(0);
        //   video.play().catch(e => log(`Error playing video: ${e.message}`));
        // }
      };

      ws.onerror = (error) => {
        log(`WebSocket error: ${error.message}`);
      };

      sourceBuffer.addEventListener('updateend', () => {
        log('Source buffer updated');
      });
    });

    video.addEventListener('error', (e) => {
      log(`Video error: ${video.error.message}`);
    });

    // Additional event listeners for debugging
    video.addEventListener('loadedmetadata', () => log('Video loadedmetadata'));
    video.addEventListener('loadeddata', () => log('Video loadeddata'));
    video.addEventListener('canplay', () => log('Video canplay'));
    video.addEventListener('play', () => log('Video play'));
    video.addEventListener('pause', () => log('Video pause'));
    video.addEventListener('error', (event) => {
      console.error('Video error:', event.target.error);
      log(`Video error: ${event.target.error.message}`);
    });
    mediaSource.addEventListener('sourceended', () => log('MediaSource ended'));
  </script>
</body>
</html>