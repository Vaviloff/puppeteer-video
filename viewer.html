<!DOCTYPE html>
<html>
<head>
  <title>Video Stream Viewer</title>
</head>
<body>
  <div style="position: relative; width: 640px; height: 320px; border: 2px solid rgb(52, 52, 129); border-radius: 5px">
    <div style="display: inline-block; padding: 5px 10px; 
    background: rgb(192, 59, 59); color: white; 
    font-weight: bold; position: absolute; left: 0; top: 0;z-index: 1">LIVE FEED</div>
    <video id="videoElement" controls 
    width="640" height="320" 
    style=""></video>
  </div>
  <br>
  <textarea id="status" style="width:640px; height: 320px"></textarea>
  <script>
    const video = document.getElementById('videoElement');
    const status = document.getElementById('status');
    const mediaSource = new MediaSource();
    let isPlaying = false;
    video.src = URL.createObjectURL(mediaSource);

    video.addEventListener('error', (event) => {
      console.error('Video error:', event.target.error);
    });
    
    video.addEventListener('loadedmetadata', () => {
      console.log('Loaded metadata');
    });

    video.addEventListener('loadeddata', () => {
      console.log('Loaded data');
    });

    video.addEventListener('canplay', () => {
      console.log('Can play');
    });

    video.addEventListener('play', () => {
      console.log('Playing');
    });

    mediaSource.addEventListener("sourceended", function() {
      console.log("Media source ended");
    });

    mediaSource.addEventListener("sourceclose", function() {
      console.log("Media source closed");
    });

    mediaSource.addEventListener("error", function(e) {
      console.error("Media source error:", e);
    });

    mediaSource.addEventListener('sourceopen', () => {
      status.textContent = 'MediaSource opened';
      const sourceBuffer = mediaSource.addSourceBuffer('video/webm;codecs=vp8');
      const ws = new WebSocket('ws://localhost:8080');

      ws.onopen = () => {
        status.textContent += '\nWebSocket connected';
      };

      ws.onmessage = async (event) => {
        status.textContent += '\nReceived chunk of size: ' + event.data.size;
        console.log(typeof event.data);

        const blob = new Blob([event.data]);
        const data = await blob.arrayBuffer();

        if (!sourceBuffer.updating) {
          sourceBuffer.appendBuffer(data);
        } else {
          console.log("Waiting for previous append to complete...");
        }

        if (!isPlaying) {
          video.play();
          isPlaying = true;
        }
      };

      ws.onerror = (error) => {
        status.textContent += '\nWebSocket error: ' + error.message;
      };

      sourceBuffer.addEventListener('updateend', () => {
        status.textContent += '\nSource buffer updated';
      });
    });

    video.addEventListener('error', (e) => {
      status.textContent += '\nVideo error: ' + video.error.message;
    });
  </script>
</body>
</html>